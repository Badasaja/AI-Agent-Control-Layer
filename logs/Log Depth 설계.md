
## 로그 계층 구조 및 노출 정책 설계

은행 신용 프로세스 등 고신뢰성 시스템에서는 '시스템 안정성'과 '비즈니스 추론 근거'를 엄격히 분리해야 함. 로그의 깊이를 4단계로 정의하여 노출 범위를 제어하는 설계를 제안함.

---

### 1. 로그 성격의 근본적 분류

- **세션 로그 (Session Log):** 시스템 실행 컨텍스트. 엔진의 가동, 에이전트 호출, API 응답 시간, 시스템 오류 등 기술적 지표 위주임.
    
- **토큰 로그 (Token Log):** 리소스(기차)의 역사적 기록. 최초 질문, 에이전트의 사고 과정(Reasoning), 가드 통과 사유, 데이터 출처(Provenance)를 포함함.
    

---

### 2. 로그 깊이(Depth) 설계 (4-Tier)

사용자 경험과 시스템 보안을 고려한 계층적 설계임.

|**단계**|**명칭**|**대상 데이터**|**사용자 노출 여부**|
|---|---|---|---|
|**Depth 0**|**Surface**|최종 답변, 현재 진행 단계 명칭 (예: "리스크 평가 중"), 치명적 시스템 에러.|**전체 노출**|
|**Depth 1**|**Logical**|**가드(Guard) 조건 평가 결과**, 분기 결정 사유, 비즈니스 경고(Warning).|**선택적 노출** (승인 요청 시)|
|**Depth 2**|**Provenance**|**에이전트 사고 과정(Reasoning)**, 참조 문서/청크 ID, 최초 질문 원문.|**감사 시 노출** (Toggle 방식)|
|**Depth 3**|**Debug**|Raw JSON 토큰 전문, LLM API 호출/응답 메시지, 엔진 내부 상태 변수.|**비노출** (관리자 전용)|

---

### 3. 세부 운영 로직 및 저장 전략

#### **분기 로직 및 경고 노출 (Depth 1)**

- 가드 실패(Deadlock) 또는 임계치 근접 시 사용자의 개입이 필요함.
- "리스크 점수 0.82로 임계치(0.85)에 근접함. 주의가 필요함"과 같은 비즈니스 로직 로그는 토큰의 `metadata.history`에 기록 후 Depth 1 채널로 스트리밍함.
    

#### **최초 질문 및 추론 기록 (Depth 2)**

- **최초 질문 저장:** 토큰 생성 시 `metadata.initial_context` 필드에 영구 박제함.
- **추론 과정 누적:** 각 전이(Transition) 성공 시 에이전트가 반환한 `reasoning` 필드를 토큰의 `metadata.steps` 배열에 Append함.
    
- 이는 세션이 종료된 후에도 토큰만 읽으면 전체 사고 흐름을 복구할 수 있게 함.
    
#### **세션 로그 격리 (Depth 3)**

- 데이터베이스의 `SESSION_LOG` 테이블에 저장하며, 사용자의 `session_id`와 매핑함.
- 사용자 화면에는 절대 노출하지 않으며, 기술적 장애 디버깅 시에만 개발자가 참조함.
    
---

### 4. 아키텍처적 보완

- **Log Filter Middleware:** 엔진 루프 내에서 발생한 로그 이벤트를 구독하여, 현재 설정된 `user_log_level`에 따라 필터링하여 UI로 전송함.
- **Sensitive Data Masking:** Depth 2 이상의 로그에 개인정보나 내부 기밀이 포함될 경우, UI 전송 전 마스킹 처리 로직을 가드(Guard) 레벨에서 강제함.
    
